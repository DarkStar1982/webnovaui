<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>WebNOVA Mission Dashboard</title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet" />
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
  <!-- CSS Files -->
  <link href="assets/css/black-dashboard.css?v=1.0.0" rel="stylesheet" />
  <link href="assets/exodus/app_dash.css" rel="stylesheet" />
  <link href="assets/exodus/demo.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin="" />
  <script type="text/javascript" src="assets/js/core/jquery.min.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>


  <script>
    var map;
    let hostname = location.hostname;
    var api_server = "http://"+hostname;
    var fov_polygons = [];
    var local_cache = {};

    if (hostname = 'localhost') api_server = api_server + ':8000/';
    else api_server = api_server + '/';

    function set_map()
    {
      var input_str = $("#search_bar").val();
      var lat_val = input_str.split(",")[0].trim();
      var lon_val = input_str.split(",")[1].trim();
      var zoom_l = map.getZoom();
      map.panTo([lat_val, lon_val], zoom_l);
      redraw_fov_polygon();
    }

    function km_to_deg_lat(input_km)
    {
      return input_km/110.5;
    }

    function km_to_deg_lon(input_km, latitude)
    {
      return input_km/(111.32*Math.cos(latitude*3.14/180));
    }

    function redraw_fov_polygon()
    {
      //get instrument paramaters
      var call_str_instruments = api_server +"webnova/v1/instruments/";
      var call_str_fov = api_server+"webnova/v1/field_of_view"
      var satellite_id = $("#satellites").val();
      var instrument_id = $("#instruments").val();
      if (fov_polygons.length>0) fov_polygons.forEach(function(item){map.removeLayer(item)});
      //load instrument data
      $.get(call_str_instruments, function( data ) {
        var instrument_list = JSON.parse(data);
        for (var i=0;i<instrument_list.length;i++)
        {
          if (instrument_list[i]["norad_id"]==satellite_id) 
          {
            fov_degs = instrument_list[i]["instruments"][0]["fov"];
            call_str_fov = call_str_fov+"?fov="+fov_degs+"&alt=550"
            $.get(call_str_fov, function(data){
              var fov_value = data;
              //get center point
              var centre_point = map.getCenter();

              //convert fov in km to degrees
              var lat_width = km_to_deg_lat(fov_value);
              var lon_width = km_to_deg_lon(fov_value, centre_point.lat);

              var north_lat = centre_point.lat + lat_width/2.0;
              var south_lat = centre_point.lat - lat_width/2.0;
              var west_lon = centre_point.lng - lon_width/2.0;
              var east_lon = centre_point.lng + lon_width/2.0;
              
              var fov_polygon = L.polygon([
                [north_lat, east_lon],
                [south_lat, east_lon],
                [south_lat, west_lon],
                [north_lat, west_lon]
              ]).addTo(map);
              fov_polygons.push(fov_polygon);
              //draw rectangle
            });
          }
        }
      });

    }

    $(document).ready(function () {
      $("#dialog_text").hide();
      map = L.map('map').setView([46.19, 30.35], 10);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
      
      redraw_fov_polygon();
      
      $("#datepicker_start").datepicker();
      $("#datepicker_start").datepicker('setDate', 'today');

      $("#datepicker_end").datepicker();

      var search_bar = document.getElementById("search_bar");
      search_bar.addEventListener("keypress", function(event) {
        // If the user presses the "Enter" key on the keyboard
        if (event.key === "Enter") {
          // Cancel the default action, if needed
          event.preventDefault();
          set_map();
        }
      });

    });

  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(1, '0');
    const hours = String(date.getHours()).padStart(1, '0');
    const minutes = String(date.getMinutes()).padStart(1, '0');
    const seconds = String(date.getSeconds()).padStart(1, '0');
    return `${year},${month},${day},${hours},${minutes},${seconds}`;
  }


    function request_pass_list()
    {
      var start_date_value = $("#datepicker_start").datepicker('getDate');
      var end_date_value = $("#datepicker_end").datepicker('getDate');
      var position = map.getCenter();
      var lon = position.lng;
      var lat = position.lat;
      //# change to the correct times, satellite and geographic coordinates
      var net = formatDate(start_date_value);
      var nlt = formatDate(end_date_value);
      var api_str = "webnova/v1/times_on_target/?norad_id=44878&net="+net+"&nlt="+nlt+"&lat="+lat+"&lng="+lon;
      var api_str = api_server + api_str; 
      $.get(api_str, function( data ) {
        var passes = JSON.parse(data)["target_passes"];
        $("#available_pass_list").empty();
        for (var i=0;i<passes.length;i++)
        {
          $("#available_pass_list").append('<tr class="pass_data_row"><td class="pass_start">'+passes[i][0]+'</td><td class="pass_end">'+passes[i][1]+'</td><td><input type="checkbox" class="selected_pass"/></td></tr>');
        }
      });

      $("#target_lat").text(position.lat);
      $("#target_lon").text(position.lng);
    }

    function get_selected_passes()
    {
      var passes = [];
      $('#available_pass_list tr').each(function() {
        if ($(this).find(".selected_pass:checked").val()=='on')
        {
          var pass_start = $(this).find(".pass_start").html(); 
          var pass_finish = $(this).find(".pass_end").html(); 
          passes.push([pass_start, pass_finish]);
        }
      });
      return passes;
    }


    function launch_mission()
    {
      //create a mission object
      var position = map.getCenter();
 
      var mission_data = {
        satellite: $("#satellites").val(),
        instrument: $("#instruments").val(),
        loc_lat: position.lat,
        loc_lon: position.lng,
        start_date: $("#datepicker_start").datepicker('getDate'),
        mission_type: "RGB",
        description:"EO_DEMO",
        passes: get_selected_passes(),
      }
      var user = "demo_user";
      var email = "demo@email.com";
      // Here be api call to server with new mission
      var api_str_post = api_server +"webnova/v1/create_mission/";
      $.post(api_str_post, {
          "mission_instance":JSON.stringify(mission_data),
          "user":user,
          "email":email
        }).done( function(data) {
      });
   }

  </script>
</head>

<body>
  <div class="content header-lane">
    <div class="row pl-5">
      <div class="col-12 text-left ml-1 logo-col-row pl-5">
        <a href="apps.html">
          <img class="logo" src="assets/img/logo-white.png">
          <h2>RGB Imager</h2>
        </a>
      </div>
    </div>
  </div>

  <div class="wrapper mt-5 mr-1 ml-1 apps-wrapper">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#config" role="tab" aria-controls="home"
          aria-selected="true">Create</a>
      </li>
      </li>
    </ul>
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="config" role="tabpanel" aria-labelledby="home-tab">
        <div class="row map-row">
          <div class="col-12">
            <!-- DASHBOARD -->
            <br />
            <div class="row">
              <div class="col-lg-8 col-sm-8 map-col">
                <input class="form-control" type="text"  width="100px" id="search_bar"/><br/>
                <div id="map"></div>
              </div>
              <div class="col-lg-3 col-sm-3">
                <h4>Select satellite</h4>
                <select id="satellites" class="form-control">
                  <option value="44878">LANDSAT</option>
                </select><br/>
                <h4>Select dataset</h4>

                <select id="instruments" class="form-control">
                  <option value="gls_all">Global Land Survey</option>
                </select><br/>
                <h4>Schedule Pass </h4>
                <table class="table">
                  <tr>
                    <td>Start Date: <input type="text" id="datepicker_start"></p></td>
                  </tr>
                  <tr>
                    <td>End Date:&nbsp;&nbsp; <input type="text" id="datepicker_end"></p></td>
                  </tr>
                </table>
                <button type="button" class="btn btn-info btn-lg button" data-toggle="modal" data-target="#myModal" onclick="request_pass_list()">Create Mission</button>
              </div>
            </div>
          </div>
        </div>

    </div>
    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Launch mission</h4>
          </div>
          <div class="modal-body">
              <table class="table table-dark">
                <tr>
                  <td>Target Latitude</td><td><span id="target_lat">0.00</span></td>
                </tr>
                <tr>
                  <td>Target Longitude</td><td><span id="target_lon">0.00</span></td>
                </tr>
              </table>
              <h4 class="text-dark">Select available passes</h4>
              <table class="table table-dark" >
                <tr>
                  <th class="text-white">Start Time</th><th class="text-white">End Time</th><th></th>
                <tbody id="available_pass_list">
                </tbody>
                </tr>
              </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Abort</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="launch_mission()">Launch!</button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!--   Core JS Files   -->
  <script type="text/javascript" src="assets/js/core/popper.min.js"></script>
  <script type="text/javascript" src="assets/js/core/bootstrap.min.js"></script>
  <script type="text/javascript" src="assets/js/plugins/chartjs.min.js"></script>
  <script type="text/javascript" src="assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <script type="text/javascript" src="assets/js/plugins/bootstrap-notify.js"></script>

  <script type="text/javascript" src="assets/js/black-dashboard.min.js?v=1.0.0"></script>
  <script type="text/javascript" src="assets/exodus/general.js"></script>
  <script type="text/javascript" src="assets/exodus/init.js"></script>
</body>

</html>
